<template>
  <li class="tabShell" 
    :class="{activeTabShell: isActiveTab}" 
    @mousedown.left="clickTab()" @click.middle="closeTab()">
    <div class="tab" tabindex="-1" :id="'tab_' + tab.key" :class="{activeTab: isActiveTab}">
      <div class="tabTitle" :class="{titleFade}" ref="title" >
        <span v-text="title" ref="titleText"/>
      </div>
      <span v-if="hasAudio" class='music'><fa-icon icon="music" /></span>
      <transition name="fade">
        <div class="systemButton closeTabButton" @mousedown.stop="" @click="closeTab()"  v-if="tabCount > 1">âœ•</div>
      </transition>
    </div>
  </li> 
</template>

<script>

const {ipcRenderer} = require('electron')

export default {
  name: 'tab',
  props: [
    'tab'
  ],
  data() {
    return {
      pendingDeletion: false,
      resizeObserver: undefined,
      titleFade: false,
      isCurrentlyAudible: false,
      isAudibleLoop: null
    }
  },
  computed: {
    hasAudio() {
      // this.$logger.info(this.title, "hasAudio?", this.tab.hasEmbed, this.isCurrentlyAudible)
      return this.tab.hasEmbed && this.isCurrentlyAudible
    },
    isActiveTab() {
      return this.tab.key === this.$localData.tabData.activeTabKey
    },    
    tabCount () {
      return this.$localData.tabData.tabList.length
    },
    title() {
        return this.tab.title ? this.tab.title : this.tab.url
    }
  },
  methods: {
    getId(){
      // Used by TabBar to swap tabs while dragging
      return this.tab.key
    },
    clickTab() {
      this.$localData.root.TABS_SWITCH_TO(this.tab.key)    
    },
    closeTab() {
      this.$localData.root.TABS_CLOSE(this.tab.key)
    },
    onResize() { 
      const titleWidth = this.$refs.title.getBoundingClientRect().width - 5 // Offsets 5px of padding on left
      const titleTextWidth = this.$refs.titleText.getBoundingClientRect().width
      
      this.titleFade = (titleWidth < titleTextWidth)
    },
    updateIsaudible(){
      if (this.isActiveTab || this.isCurrentlyAudible) {
        this.isCurrentlyAudible = ipcRenderer.sendSync('IS_CURRENTLY_AUDIBLE')
      }
    },
    updateIsaudibleLoop(){
      if (this.tab.hasEmbed) {
        this.$logger.info(this.tab.title, "Starting isAudible loop")
        this.isAudibleLoop = setInterval(() => {this.updateIsaudible()}, 1000)
      } else {
        this.$logger.info(this.tab.title, "has no embed, no isAudible")
        clearInterval(this.isAudibleLoop)
      }
      this.updateIsaudible()
    }
  },
  watch: {
    'tab.title'(){
      this.$nextTick(this.onResize)
    },
    'tab.hasEmbed'(to, from){
      this.updateIsaudibleLoop()
    },
    'tab.url'(to, from){
      this.updateIsaudibleLoop()
    }
  },
  created() {
    this.updateIsaudibleLoop()
  },
  mounted() {
    this.updateIsaudibleLoop()
    this.resizeObserver = new ResizeObserver(this.onResize)
    this.resizeObserver.observe(this.$refs.title)
  },
  beforeDestroy() {
    this.resizeObserver.disconnect()
  }
}
</script>

<style lang="scss" scoped>
.tabShell {
  border-right: solid 1px var(--header-border);
  display: inline-flex;
  width: 240px;
  min-width: 30px;
  flex: 0 10 auto;
}
.tab {
  display: inline-flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  min-width: 0;
  height: var(--tab-height);
  cursor: default;
  padding-right: 8px;

  &:not(.activeTab) {
    &:hover {
      background: var(--header-buttonHoverState);
    }
    &:active {
      background: var(--header-buttonClickState);
    }
  }

  &.activeTab {
    background: var(--header-bg);
  }

  .tabTitle {
    flex: 1 10 auto;
    padding-left: 5px;
    white-space: nowrap;
    min-width: 0;
    overflow: hidden;
    pointer-events: none;
    
    &.titleFade {
      mask-image: linear-gradient(90deg, #000000 calc(100% - 20px), #00000000 100%);
    }
  }

  .music, .closeTabButton {
    flex: 0 0 auto;
    width: 21px;
    height: 21px;
  }

  .closeTabButton {
    float: right;
    padding: 0;
    margin-right: -2px;

    line-height: 22px;
    font-family: Arial, Helvetica, sans-serif;
  }

  .music {
    display: flex;
    justify-content: center;
    align-items: center;
  }
}

.fade-enter-active, .fade-leave-active {
  transition: all .1s;
}
.fade-enter, .fade-leave-to {
  opacity: 0;
  transform: translateX(30px);
}
</style>